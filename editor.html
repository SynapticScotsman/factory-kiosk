<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Smart Factory - EDITOR</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&family=Montserrat:wght@400;500;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #editor-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            overflow: auto;
        }

        .factory-container {
            position: relative;
            max-width: 1200px;
            width: 100%;
            margin: auto;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            flex-shrink: 0;
            background: url('Artboard 1@4x.png') center/cover no-repeat;
            aspect-ratio: 1400 / 788;
        }

        .hotspot {
            position: absolute;
            width: 110px;
            height: 110px;
            border-radius: 50%;
            cursor: move;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            text-align: center;
            color: white;
            font-weight: 600;
            line-height: 1.2;
            text-transform: uppercase;
            border: 2px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.1s, box-shadow 0.1s;
            padding-bottom: 25px;
            box-sizing: border-box;
            user-select: none;
        }
        
        .hotspot.selected {
            box-shadow: 0 0 0 4px #4299e1, 0 4px 15px rgba(0,0,0,0.2);
            z-index: 100;
        }
        
        .hotspot-icon {
            position: absolute;
            width: 75px;
            height: 75px;
            top: -38px;
            left: 50%;
            transform: translateX(-50%);
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
            pointer-events: none;
        }

        .hotspot-text { font-size: 0.8rem; }
        .hotspot.productivity { background-color: #4A90E2; }
        .hotspot.safety { background-color: #f56565; }
        .hotspot.quality { background-color: #ed64a6; }
        .hotspot.predictive-maintenance { background-color: #4a5568; }

        .hotspot::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            --spotlight-angle: 0deg;
            --spotlight-length: 120px;
            width: 60px;
            height: var(--spotlight-length);
            z-index: -1;
            pointer-events: none;
            transform-origin: top center;
            transform: translateX(-50%) rotate(var(--spotlight-angle));
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }
        .hotspot.productivity::before { background: linear-gradient(to bottom, rgba(74, 144, 226, 0.7) 0%, rgba(74, 144, 226, 0) 100%); }
        .hotspot.safety::before { background: linear-gradient(to bottom, rgba(245, 101, 101, 0.7) 0%, rgba(245, 101, 101, 0) 100%); }
        .hotspot.quality::before { background: linear-gradient(to bottom, rgba(237, 100, 166, 0.7) 0%, rgba(237, 100, 166, 0) 100%); }
        .hotspot.predictive-maintenance::before { background: linear-gradient(to bottom, rgba(74, 85, 104, 0.7) 0%, rgba(74, 85, 104, 0) 100%); }
        
        /* Control Panel */
        #control-panel {
            width: 350px;
            flex-shrink: 0;
            background-color: #fff;
            padding: 1.5rem;
            box-shadow: -5px 0 20px rgba(0,0,0,0.05);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        #control-panel h2 {
            margin-top: 0;
            font-size: 1.5rem;
            color: #2d3748;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .control-group { margin-bottom: 1.25rem; }
        .control-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: #4a5568; }
        .control-group input, .control-group select, .control-group textarea { width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid #cbd5e0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        .control-group textarea { resize: vertical; min-height: 80px; }
        .control-group input[type="range"] { padding: 0; }

        .button-group { margin-top: auto; padding-top: 1.5rem; border-top: 1px solid #e2e8f0; }
        .button-group button, .button-group a { display: block; width: 100%; padding: 0.75rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; text-align: center; text-decoration: none; margin-bottom: 0.5rem; box-sizing: border-box; transition: background-color 0.2s; }

        #add-hotspot { background-color: #3182ce; color: white; }
        #add-hotspot:hover { background-color: #2b6cb0; }
        #delete-hotspot { background-color: #e53e3e; color: white; }
        #delete-hotspot:hover { background-color: #c53030; }
        #save-config { background-color: #38a169; color: white; }
        #save-config:hover { background-color: #2f855a; }
        #back-to-view { background-color: #f7fafc; border: 1px solid #e2e8f0; color: #2d3748; }
        #back-to-view:hover { background-color: #e2e8f0; }
        
        #no-selection { text-align: center; color: #718096; margin-top: 2rem; }
    </style>
</head>
<body>

    <div id="editor-container">
        <div class="factory-container" id="factory-container">
            <!-- Draggable hotspots will be generated here -->
        </div>
    </div>

    <aside id="control-panel">
        <h2>Hotspot Editor</h2>
        <div id="hotspot-controls" style="display: none;">
             <div class="control-group">
                <label for="hotspot-text">Display Text (use &lt;br&gt; for new line)</label>
                <textarea id="hotspot-text" rows="2"></textarea>
            </div>
            <div class="control-group">
                <label for="hotspot-topic">Topic Link</label>
                <select id="hotspot-topic"></select>
            </div>
            <div class="control-group">
                <label for="hotspot-category">Category</label>
                <select id="hotspot-category">
                    <option value="productivity">Productivity</option>
                    <option value="safety">Safety</option>
                    <option value="quality">Quality</option>
                    <option value="predictive-maintenance">Predictive Maintenance</option>
                </select>
            </div>
            <div class="control-group">
                <label for="hotspot-icon">Icon</label>
                <select id="hotspot-icon">
                    <option value="eyelogo.png">Eye</option>
                    <option value="earlogo.png">Ear</option>
                </select>
            </div>
            <div class="control-group">
                <label for="spotlight-angle">Spotlight Angle</label>
                <input type="range" id="spotlight-angle" min="-180" max="180" value="0">
            </div>
            <div class="control-group">
                <label for="spotlight-length">Spotlight Length</label>
                <input type="range" id="spotlight-length" min="50" max="250" value="120">
            </div>
        </div>
        <div id="no-selection">
            <p>Click a hotspot to edit it, or add a new one.</p>
        </div>

        <div class="button-group">
            <button id="add-hotspot">+ Add New Hotspot</button>
            <button id="delete-hotspot" style="display:none;">- Delete Selected</button>
            <button id="save-config">üíæ Save & Download config.json</button>
            <a href="index.html" id="back-to-view">‚Ü©Ô∏è Back to View</a>
        </div>
    </aside>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const factoryContainer = document.getElementById('factory-container');
        const hotspotControls = document.getElementById('hotspot-controls');
        const noSelectionPanel = document.getElementById('no-selection');
        
        const textInput = document.getElementById('hotspot-text');
        const topicSelect = document.getElementById('hotspot-topic');
        const categorySelect = document.getElementById('hotspot-category');
        const iconSelect = document.getElementById('hotspot-icon');
        const angleInput = document.getElementById('spotlight-angle');
        const lengthInput = document.getElementById('spotlight-length');
        
        const addButton = document.getElementById('add-hotspot');
        const deleteButton = document.getElementById('delete-hotspot');
        const saveButton = document.getElementById('save-config');
        
        let hotspotsData = [];
        let selectedHotspot = null;
        let nextId = 0;

        const initialTopics = ['agv', 'pick-place', 'conveyor', 'barcode', 'area-monitoring', 'spatter', 'fluid-dynamics', 'particle-size', 'high-speed', 'vibration'];
        initialTopics.forEach(topic => {
            const option = document.createElement('option');
            option.value = topic;
            option.textContent = topic.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            topicSelect.appendChild(option);
        });

        function renderHotspots() {
            factoryContainer.querySelectorAll('.hotspot').forEach(h => h.remove());
            hotspotsData.forEach(data => {
                const hotspotEl = document.createElement('div');
                hotspotEl.className = `hotspot ${data.category}`;
                hotspotEl.dataset.id = data.id;
                hotspotEl.style.left = data.left;
                hotspotEl.style.top = data.top;
                hotspotEl.style.setProperty('--spotlight-angle', `${data.angle}deg`);
                hotspotEl.style.setProperty('--spotlight-length', `${data.length}px`);
                hotspotEl.innerHTML = `<img src="${data.icon}" class="hotspot-icon"><div class="hotspot-text">${data.text.replace(/\n/g, '<br>')}</div>`;
                factoryContainer.appendChild(hotspotEl);
            });
            addDragListeners();
            addSelectListeners();
        }
        
        function updateEditorControls() {
            if (!selectedHotspot) {
                hotspotControls.style.display = 'none';
                deleteButton.style.display = 'none';
                noSelectionPanel.style.display = 'block';
                return;
            }
            const data = hotspotsData.find(h => h.id == selectedHotspot.dataset.id);
            if (!data) return;

            textInput.value = data.text;
            topicSelect.value = data.topic;
            categorySelect.value = data.category;
            iconSelect.value = data.icon;
            angleInput.value = data.angle;
            lengthInput.value = data.length;
            
            hotspotControls.style.display = 'block';
            deleteButton.style.display = 'block';
            noSelectionPanel.style.display = 'none';
        }

        function selectHotspot(hotspotElement) {
            if (selectedHotspot) {
                selectedHotspot.classList.remove('selected');
            }
            selectedHotspot = hotspotElement;
            if (selectedHotspot) {
                selectedHotspot.classList.add('selected');
            }
            updateEditorControls();
        }

        function addSelectListeners() {
            factoryContainer.querySelectorAll('.hotspot').forEach(hotspot => {
                hotspot.addEventListener('click', (e) => selectHotspot(e.currentTarget));
            });
        }
        
        function addDragListeners() {
            factoryContainer.querySelectorAll('.hotspot').forEach(hotspot => {
                hotspot.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    selectHotspot(hotspot); // Select on drag start
                    
                    const rect = factoryContainer.getBoundingClientRect();
                    document.onmousemove = function(moveEvent) {
                        let x = moveEvent.clientX - rect.left;
                        let y = moveEvent.clientY - rect.top;
                        x = Math.max(0, Math.min(x, rect.width));
                        y = Math.max(0, Math.min(y, rect.height));

                        const xPercent = (x / rect.width * 100).toFixed(2) + '%';
                        const yPercent = (y / rect.height * 100).toFixed(2) + '%';
                        hotspot.style.left = xPercent;
                        hotspot.style.top = yPercent;
                        
                        const data = hotspotsData.find(h => h.id == hotspot.dataset.id);
                        if (data) {
                            data.left = xPercent;
                            data.top = yPercent;
                        }
                        // Live update sliders as the hotspot is dragged
                        updateEditorControls();
                    };
                    document.onmouseup = () => {
                        document.onmousemove = null;
                        document.onmouseup = null;
                    };
                });
            });
        }
        
        // --- Control Panel Event Listeners (FIXED) ---
        textInput.addEventListener('input', () => {
            if (!selectedHotspot) return;
            const data = hotspotsData.find(h => h.id == selectedHotspot.dataset.id);
            if(data) {
                data.text = textInput.value;
                selectedHotspot.querySelector('.hotspot-text').innerHTML = data.text.replace(/\n/g, '<br>');
            }
        });
        
        topicSelect.addEventListener('change', () => {
            if (!selectedHotspot) return;
            const data = hotspotsData.find(h => h.id == selectedHotspot.dataset.id);
            if(data) data.topic = topicSelect.value;
        });

        categorySelect.addEventListener('change', () => {
            if (!selectedHotspot) return;
            const data = hotspotsData.find(h => h.id == selectedHotspot.dataset.id);
            if(data) {
                data.category = categorySelect.value;
                selectedHotspot.className = `hotspot selected ${data.category}`;
            }
        });

        iconSelect.addEventListener('change', () => {
            if (!selectedHotspot) return;
            const data = hotspotsData.find(h => h.id == selectedHotspot.dataset.id);
            if(data) {
                data.icon = iconSelect.value;
                selectedHotspot.querySelector('.hotspot-icon').src = data.icon;
            }
        });

        angleInput.addEventListener('input', () => {
            if (!selectedHotspot) return;
            const data = hotspotsData.find(h => h.id == selectedHotspot.dataset.id);
            if(data) {
                data.angle = angleInput.value;
                selectedHotspot.style.setProperty('--spotlight-angle', `${data.angle}deg`);
            }
        });

        lengthInput.addEventListener('input', () => {
            if (!selectedHotspot) return;
            const data = hotspotsData.find(h => h.id == selectedHotspot.dataset.id);
            if(data) {
                data.length = lengthInput.value;
                selectedHotspot.style.setProperty('--spotlight-length', `${data.length}px`);
            }
        });

        addButton.addEventListener('click', () => {
            const newHotspot = {
                id: nextId++, text: 'New\nHotspot', topic: 'agv', category: 'productivity',
                icon: 'eyelogo.png', left: '50%', top: '50%', angle: '0', length: '120'
            };
            hotspotsData.push(newHotspot);
            renderHotspots();
            const newEl = factoryContainer.querySelector(`[data-id="${newHotspot.id}"]`);
            selectHotspot(newEl);
        });

        deleteButton.addEventListener('click', () => {
            if (!selectedHotspot) return;
            hotspotsData = hotspotsData.filter(h => h.id != selectedHotspot.dataset.id);
            selectedHotspot.remove();
            selectHotspot(null);
        });
        
        saveButton.addEventListener('click', () => {
             // Create a clean version of the data for export (without the 'id')
            const exportData = hotspotsData.map(({ id, ...rest }) => rest);
            const configString = JSON.stringify(exportData, null, 2);

            // Save to browser's local storage for the main page
            localStorage.setItem('hotspotConfig', configString);
            
            // Trigger a file download
            const blob = new Blob([configString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'config.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Configuration saved to browser and downloaded as config.json!');
        });

        // --- Initial Load ---
        function loadInitialConfig() {
            const savedConfig = localStorage.getItem('hotspotConfig');
            let initialData = [];
            if (savedConfig) {
                initialData = JSON.parse(savedConfig);
            } else {
                 // Fallback to a default set if nothing is saved
                initialData = [
                    { topic: "agv", text: "AGV & SVG<br>Tracking", top: "80%", left: "15%", angle: 45, length: 120, category: "productivity", icon: "eyelogo.png" },
                    { topic: "pick-place", text: "Pick & Place", top: "75%", left: "25%", angle: 45, length: 120, category: "productivity", icon: "eyelogo.png" },
                    { topic: "conveyor", text: "Conveyor Speed<br>Measurement", top: "65%", left: "50%", angle: -45, length: 120, category: "productivity", icon: "eyelogo.png" },
                    { topic: "barcode", text: "Barcode<br>Localization", top: "60%", left: "65%", angle: -45, length: 120, category: "productivity", icon: "eyelogo.png" },
                    { topic: "area-monitoring", text: "Area<br>Monitoring", top: "40%", left: "30%", angle: 45, length: 120, category: "safety", icon: "eyelogo.png" },
                    { topic: "spatter", text: "Spatter<br>Monitoring", top: "70%", left: "45%", angle: 0, length: 120, category: "safety", icon: "eyelogo.png" },
                    { topic: "fluid-dynamics", text: "Fluid Dynamics<br>Monitoring", top: "25%", left: "85%", angle: -135, length: 120, category: "safety", icon: "eyelogo.png" },
                    { topic: "particle-size", text: "Particle Size<br>Monitoring", top: "40%", left: "70%", angle: -135, length: 120, category: "quality", icon: "eyelogo.png" },
                    { topic: "high-speed", text: "High-Speed<br>Counting", top: "55%", left: "80%", angle: -90, length: 120, category: "quality", icon: "eyelogo.png" },
                    { topic: "vibration", text: "Vibration<br>Measurement", top: "50%", left: "40%", angle: 135, length: 120, category: "predictive-maintenance", icon: "earlogo.png" }
                ];
            }
            hotspotsData = initialData.map((item, index) => ({...item, id: index}));
            nextId = hotspotsData.length;
            renderHotspots();
        }

        loadInitialConfig();
    });
    </script>
</body>
</html>

